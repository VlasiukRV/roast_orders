<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>SPA Orders & Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<!-- Header —Å –∫–Ω–æ–ø–∫–æ–π Logout -->
<header class="fixed top-0 left-0 right-0 bg-white shadow z-50 px-6 py-4 flex justify-end">
    <button
            id="logoutBtn"
            class="hidden bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition"
    >
        Logout
    </button>
</header>

<div class="max-w-4xl mx-auto mt-24">

    <!-- AUTH SECTION -->
    <div id="auth-section" class="max-w-md mx-auto p-6 bg-white rounded-xl shadow-lg">
        <h1 id="title" class="text-3xl font-bold mb-6 text-center">Login</h1>

        <div class="flex justify-center space-x-4 mb-6">
            <button
                    class="px-4 py-2 rounded-lg border border-blue-500 text-blue-500 hover:bg-blue-50 transition"
                    onclick="showForm('login')"
                    id="loginBtn"
            >Login
            </button>
            <button
                    class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition"
                    onclick="showForm('register')"
                    id="registerBtn"
            >Register
            </button>
        </div>

        <!-- Login Form -->
        <div id="login" class="form-section">
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Username</label>
                    <input type="text" name="username" required
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"/>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" name="password" required
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"/>
                </div>
                <button
                        type="submit"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded transition"
                >Login
                </button>
                <p id="loginStatus" class="mt-2 text-sm min-h-[1.25rem]"></p>
            </form>
        </div>

        <!-- Register Form -->
        <div id="register" class="form-section hidden">
            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Username</label>
                    <input type="text" name="username" required
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"/>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" name="password" required
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"/>
                </div>
                <button
                        type="submit"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded transition"
                >Register
                </button>
                <p id="registerStatus" class="mt-2 text-sm min-h-[1.25rem]"></p>
            </form>
        </div>
    </div>

    <!-- ORDERS SECTION -->
    <div id="orders-section" class="hidden">
        <h1 class="text-3xl font-bold mb-6">All Orders</h1>
        <div id="orders-list" class="space-y-4">
            <!-- –ó–∞–∫–∞–∑—ã —Å—é–¥–∞ –≤—Å—Ç–∞–≤–∏–º —á–µ—Ä–µ–∑ JS -->
        </div>

        <div class="flex justify-center mt-8 space-x-2" id="pagination">
            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        </div>
    </div>
</div>

<script>
    // --- –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ Logout –≤ —Ö–µ–¥–µ—Ä–µ ---
    const logoutBtn = document.getElementById('logoutBtn');

    function isLoggedIn() {
        return !!localStorage.getItem('access_token');
    }

    function updateUI() {
        if (isLoggedIn()) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('orders-section').classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            loadOrders(currentPage);
        } else {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('orders-section').classList.add('hidden');
            logoutBtn.classList.add('hidden');
        }
    }

    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        updateUI();
    }

    logoutBtn.addEventListener('click', logout);

    // –û—Å—Ç–∞–ª—å–Ω–æ–π —Ç–≤–æ–π –∫–æ–¥ –¥–ª—è –ª–æ–≥–∏–Ω–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    let currentPage = 1;
    let totalPages = 1;

    function showForm(type) {
        document.getElementById("title").textContent = type === 'login' ? 'Login' : 'Register';
        document.querySelectorAll(".form-section").forEach(div => div.classList.add("hidden"));
        document.getElementById(type).classList.remove("hidden");

        document.getElementById('loginStatus').textContent = '';
        document.getElementById('registerStatus').textContent = '';
    }

    function setStatus(formType, message, isError = true) {
        const statusEl = document.getElementById(formType + "Status");
        statusEl.textContent = message;
        statusEl.style.color = isError ? 'red' : 'green';
    }

    async function openInvoice(orderId) {
        const token = localStorage.getItem('access_token');

        try {
            const res = await fetch(`/api/order/invoice/${orderId}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!res.ok) throw new Error("Failed to fetch PDF");

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);

            window.open(url, '_blank');
        } catch (err) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å PDF: " + err.message);
        }
    }

    async function loadOrders(page = 1) {
        currentPage = page;
        const token = localStorage.getItem('access_token');

        try {
            const res = await fetch(`/api/order/orders?page=${page}`, {
                headers: {'Authorization': 'Bearer ' + token}
            });
            if (!res.ok) throw new Error('Failed to fetch orders');
            const data = await res.json();

            totalPages = data.total_pages || 1;

            renderOrders(data.orders);
            renderPagination();
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ' + error.message);
            if (error.message.includes('401')) {
              logout();
            }
        }
    }

    function getStatusColor(status) {
      switch (status) {
        case 'In Process':
          return 'bg-yellow-200 text-yellow-800';
        case 'Accepted':
          return 'bg-green-200 text-green-800';
        case 'Completed':
          return 'bg-blue-200 text-blue-800';
        case 'Rejected':
          return 'bg-red-200 text-red-800';
        default:
          return 'bg-gray-200 text-gray-800';
      }
    }
    function toggleOrderCart(orderId) {
        const cart = document.getElementById(`cart-${orderId}`);
        cart.classList.toggle('hidden');
    }

    function renderOrders(orders) {
        const container = document.getElementById('orders-list');
        container.innerHTML = '';

        orders.forEach(order => {
            const statusColor = getStatusColor(order.status);

            const div = document.createElement('div');
            div.className = "bg-white p-6 rounded-xl shadow";

            div.innerHTML = `
                <div class="mb-2 text-sm text-gray-500">${order.order_time}</div>
                <button
                        onclick="toggleOrderCart('${order.order_id}')"
                        class="mb-2 text-sm text-blue-600 hover:underline">
                    Show/Hide Cart
                </button>
                <h2 class="text-xl font-semibold">${order.name} ‚Äî ${order.email}</h2>
                <p class="text-sm text-gray-600 mb-2"> üìû ${order.phone} | üìß ${order.address}</p>


                <div id="cart-${order.order_id}" class="text-gray-800 bg-gray-50 p-4 rounded mb-2 hidden">
                    <strong>Cart:</strong><br>
                    <div class="overflow-x-auto mt-2">
                      <table class="w-full text-sm text-left border border-gray-200 rounded">
                        <thead class="bg-gray-100">
                          <tr>
                            <th class="px-3 py-2 border-b">Product</th>
                            <th class="px-3 py-2 border-b">Price</th>
                            <th class="px-3 py-2 border-b">Qty</th>
                            <th class="px-3 py-2 border-b">Total</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${JSON.parse(order.order_items).map(item => `
                            <tr class="border-t">
                              <td class="px-3 py-2">${item[1]}</td>
                              <td class="px-3 py-2">$${item[2]}</td>
                              <td class="px-3 py-2">${item[3]}</td>
                              <td class="px-3 py-2 font-semibold">$${item[4]}</td>
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>

                <div class="flex justify-between items-center mt-4">
                  <span class="font-medium">Status:
                    <span class="inline-block px-2 py-1 rounded text-gray-800 text-sm ${statusColor}">
                      ${order.status}
                    </span>
                  </span>

                  <select data-order-id="${order.order_id}" class="border rounded px-2 py-1 text-sm">
                    <option value="In Process" ${order.status === "In Process" ? "selected" : ""}>In Process</option>
                    <option value="Accepted" ${order.status === "Accepted" ? "selected" : ""}>Accepted</option>
                    <option value="Completed" ${order.status === "Completed" ? "selected" : ""}>Completed</option>
                  </select>

                  <button data-order-id="${order.order_id}" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 update-status-btn">
                    Update
                  </button>
                  <button
                    onclick="openInvoice('${order.order_id}')"
                    class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600"
                  >
                    üìÑ PDF
                  </button>
                </div>
               `;

            container.appendChild(div);
        });

        document.querySelectorAll('.update-status-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const orderId = btn.dataset.orderId;
                const select = btn.previousElementSibling;
                const newStatus = select.value;
                await updateOrderStatus(orderId, newStatus);
            });
        });
    }

    async function updateOrderStatus(orderId, status) {
        const token = localStorage.getItem('access_token');
        try {
            const res = await fetch('/api/order/update_order_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({order_id: orderId, status})
            });
            if (!res.ok) throw new Error('Failed to update status');
            alert('Status updated successfully');
            loadOrders(currentPage);
        } catch (e) {
            alert('Error updating status: ' + e.message);
        }
    }

    function renderPagination() {
        const container = document.getElementById('pagination');
        container.innerHTML = '';

        if (currentPage > 1) {
            const prev = document.createElement('button');
            prev.textContent = '‚Üê Prev';
            prev.className = 'px-4 py-2 bg-gray-200 rounded hover:bg-gray-300';
            prev.onclick = () => loadOrders(currentPage - 1);
            container.appendChild(prev);
        }

        for (let p = 1; p <= totalPages; p++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = p;
            pageBtn.className = `px-3 py-1 rounded ${p === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700'}`;
            pageBtn.onclick = () => loadOrders(p);
            container.appendChild(pageBtn);
        }

        if (currentPage < totalPages) {
            const next = document.createElement('button');
            next.textContent = 'Next ‚Üí';
            next.className = 'px-4 py-2 bg-gray-200 rounded hover:bg-gray-300';
            next.onclick = () => loadOrders(currentPage + 1);
            container.appendChild(next);
        }
    }

    // Register handler
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        setStatus('register', '');

        const formData = new FormData(form);
        const data = {
            username: formData.get("username"),
            password: formData.get("password")
        };

        try {
            const res = await fetch("/users/register", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data)
            });

            if (res.ok) {
                setStatus('register', "‚úÖ Registered successfully! Please log in now.", false);
                showForm('login');
                form.reset();
            } else {
                const err = await res.json();
                if (res.status === 400 && err.detail === "User already exists") {
                    setStatus('register', "‚ö†Ô∏è Username already exists. Please choose another one.");
                } else {
                    setStatus('register', "Registration error: " + (err.detail || "Unknown error"));
                }
            }
        } catch (error) {
            setStatus('register', "Network or server error.");
        } finally {
            submitBtn.disabled = false;
        }
    });

    // Login handler
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        setStatus('login', '');

        const formData = new FormData(form);
        const params = new URLSearchParams();
        params.append("username", formData.get("username"));
        params.append("password", formData.get("password"));

        try {
            const res = await fetch("/api/auth/token", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: params.toString()
            });

            if (res.ok) {
                const data = await res.json();
                localStorage.setItem("access_token", data.access_token);
                localStorage.setItem("refresh_token", data.refresh_token);
                setStatus('login', "Login successful! Loading orders...", false);
                updateUI();
            } else {
                const err = await res.json();
                setStatus('login', "Error: " + (err.detail || "Invalid credentials"));
            }
        } catch (error) {
            setStatus('login', "Network or server error.");
        } finally {
            submitBtn.disabled = false;
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    showForm('login');
    updateUI();

</script>
</body>
</html>
